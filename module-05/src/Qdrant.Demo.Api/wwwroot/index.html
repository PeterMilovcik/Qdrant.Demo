<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Qdrant.Demo — RAG Workshop</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
  <style>
    /* ── layout ── */
    :root { --score-high: #2ecc40; --score-mid: #ffdc00; --score-low: #ff4136; }
    body { margin: 0; }
    nav { margin-bottom: 0; }
    nav ul { margin-bottom: 0; }
    .tab-btn { cursor: pointer; opacity: .6; border-bottom: 2px solid transparent; }
    .tab-btn.active { opacity: 1; border-bottom: 2px solid var(--pico-primary); }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    main.container { max-width: 960px; padding-top: 1rem; }

    /* ── chips ── */
    .chip-list { display: flex; flex-wrap: wrap; gap: .35rem; margin: .25rem 0 .5rem; }
    .chip { display: inline-flex; align-items: center; gap: .3rem; padding: .15rem .55rem;
            border-radius: 1rem; font-size: .85rem; background: var(--pico-secondary-background); }
    .chip button { background: none; border: none; cursor: pointer; padding: 0; margin: 0;
                   font-size: .9rem; line-height: 1; color: var(--pico-color); }
    .chip-row { display: flex; gap: .35rem; align-items: end; margin-bottom: .25rem; }
    .chip-row input { margin-bottom: 0; }
    .chip-row button { margin-bottom: 0; white-space: nowrap; }

    /* ── status ── */
    .status-grid { display: grid; grid-template-columns: auto 1fr; gap: .25rem 1rem; }
    .status-grid dt { font-weight: 600; }
    .status-grid dd { margin: 0; font-family: var(--pico-font-family-monospace, monospace); }
    .health-dot { display: inline-block; width: .65rem; height: .65rem; border-radius: 50%; margin-right: .3rem; }
    .health-ok { background: var(--score-high); }
    .health-err { background: var(--score-low); }

    /* ── result cards ── */
    .result-card { border-left: 4px solid var(--pico-primary); padding: .75rem 1rem; margin-bottom: .75rem;
                   background: var(--pico-card-background-color); border-radius: var(--pico-border-radius); }
    .result-card.error { border-left-color: var(--score-low); }
    .result-card.success { border-left-color: var(--score-high); }
    .result-header { display: flex; align-items: center; gap: .75rem; flex-wrap: wrap; }
    .rank { font-weight: 700; font-size: .85rem; min-width: 2rem; }
    .score-bar-wrap { flex: 1; max-width: 220px; display: flex; align-items: center; gap: .5rem; }
    .score-bar-wrap progress { margin-bottom: 0; }
    .score-num { font-size: .85rem; font-family: monospace; min-width: 3rem; }
    .doc-id { font-family: monospace; font-size: .8rem; opacity: .7; overflow: hidden;
              text-overflow: ellipsis; white-space: nowrap; max-width: 220px; }
    .chunk-badge { font-size: .75rem; padding: .1rem .45rem; border-radius: .75rem;
                   background: var(--pico-primary); color: var(--pico-primary-inverse); white-space: nowrap; }
    .snippet { font-size: .9rem; margin: .35rem 0; }
    .result-meta { margin: 0; }
    .result-meta summary { font-size: .8rem; cursor: pointer; }
    .result-meta pre { font-size: .75rem; overflow-x: auto; }
    .results-info { font-size: .85rem; opacity: .7; margin-bottom: .5rem; }
    .empty-state { text-align: center; padding: 2rem; opacity: .5; }

    /* ── chat ── */
    .chat-area { min-height: 300px; max-height: 60vh; overflow-y: auto; padding: .5rem;
                 border: 1px solid var(--pico-muted-border-color); border-radius: var(--pico-border-radius);
                 margin-bottom: 1rem; }
    .msg { margin-bottom: .75rem; max-width: 85%; }
    .msg.user { margin-left: auto; text-align: right; }
    .msg.user .bubble { background: var(--pico-primary); color: #fff;
                        display: inline-block; padding: .5rem .85rem; border-radius: 1rem 1rem .2rem 1rem; }
    .msg.assistant .bubble { background: var(--pico-card-background-color); display: inline-block;
                             padding: .5rem .85rem; border-radius: 1rem 1rem 1rem .2rem;
                             border: 1px solid var(--pico-muted-border-color); text-align: left; }
    .msg.assistant .bubble p { margin: .25rem 0; }
    .sources-toggle { margin-top: .35rem; text-align: left; }
    .sources-toggle summary { font-size: .8rem; cursor: pointer; }
    .thinking { opacity: .5; font-style: italic; }
    .chat-input { display: flex; gap: .5rem; position: relative; z-index: 1; }
    .chat-input textarea { margin-bottom: 0; flex: 1; resize: none; field-sizing: content; max-height: 6rem; }
    .chat-input button { margin-bottom: 0; white-space: nowrap; align-self: end; }
    .chat-settings { margin-bottom: 1rem; }
    .chat-settings summary { font-size: .85rem; cursor: pointer; margin-bottom: .5rem; }
    .chat-clear { font-size: .8rem; cursor: pointer; background: none; border: none;
                  color: var(--pico-muted-color); float: right; margin-bottom: .5rem; }

    /* ── batch ── */
    .batch-stats { display: flex; gap: 1.5rem; margin: .75rem 0; font-size: .95rem; }
    .batch-stats .val { font-weight: 700; }
    .batch-stats .val.ok { color: var(--score-high); }
    .batch-stats .val.err { color: var(--score-low); }

    /* ── search mode toggle ── */
    .mode-group { display: flex; gap: 0; margin-bottom: 1rem; }
    .mode-group button { border-radius: 0; margin: 0; }
    .mode-group button:first-child { border-radius: var(--pico-border-radius) 0 0 var(--pico-border-radius); }
    .mode-group button:last-child { border-radius: 0 var(--pico-border-radius) var(--pico-border-radius) 0; }
    .mode-group button.active { background: var(--pico-primary); color: var(--pico-primary-inverse);
                                border-color: var(--pico-primary); }
    .mode-group button:not(.active) { background: var(--pico-secondary-background);
                                       color: var(--pico-color); border-color: var(--pico-muted-border-color); }

    /* ── slider readout ── */
    .slider-row { display: flex; align-items: center; gap: .75rem; }
    .slider-row input[type=range] { flex: 1; margin-bottom: 0; }
    .slider-readout { font-family: monospace; font-size: .9rem; min-width: 3rem; }

    /* ── misc ── */
    footer { text-align: center; padding: 1rem; font-size: .8rem; opacity: .5; }
    .sr-only { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); }
    #themeSelect { margin-bottom: 0; padding: .25rem 2rem .25rem .5rem; font-size: .8rem; width: auto; }
  </style>
</head>
<body>

<!-- ═══════════════════ NAV ═══════════════════ -->
<nav class="container-fluid">
  <ul><li><strong>Qdrant.Demo</strong></li></ul>
  <ul>
    <li><a class="tab-btn active" data-tab="chat" href="#">Chat</a></li>
    <li><a class="tab-btn" data-tab="search" href="#">Search</a></li>
    <li><a class="tab-btn" data-tab="docs" href="#">Documents</a></li>
    <li><a class="tab-btn" data-tab="status" href="#">Status</a></li>
    <li>
      <select id="themeSelect" onchange="setTheme(this.value)" aria-label="Theme">
        <option value="auto">Auto</option>
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>
    </li>
  </ul>
</nav>

<main class="container">

<!-- ═══════════════════ CHAT ═══════════════════ -->
<section id="tab-chat" class="tab-panel active">
  <hgroup>
    <h2>Chat</h2>
    <p>Ask questions — the RAG pipeline retrieves relevant chunks and feeds them to the LLM.</p>
  </hgroup>

  <div style="display:flex;justify-content:flex-end;margin-bottom:.25rem">
    <button class="chat-clear" onclick="clearChat()">Clear conversation</button>
  </div>
  <div class="chat-area" id="chatArea"></div>

  <details class="chat-settings">
    <summary>⚙ Advanced settings</summary>
    <div class="grid">
      <label>K (chunks to retrieve)
        <input type="number" id="chatK" value="5" min="1" max="50" />
      </label>
      <label>Score threshold (optional)
        <input type="number" id="chatThresh" step="0.05" min="0" max="1" placeholder="e.g. 0.4" />
      </label>
    </div>
    <div id="chatTagsWidget"></div>
    <label>System prompt (optional)
      <textarea id="chatPrompt" rows="2" placeholder="Leave empty to use the default RAG prompt"></textarea>
    </label>
  </details>

  <div class="chat-input">
    <textarea id="chatQ" rows="1" placeholder="Ask a question about your documents…"></textarea>
    <button type="button" id="chatSend" onclick="sendChat()">Send →</button>
  </div>
</section>

<!-- ═══════════════════ SEARCH ═══════════════════ -->
<section id="tab-search" class="tab-panel">
  <hgroup>
    <h2>Search</h2>
    <p>Query your indexed documents using three different strategies.</p>
  </hgroup>

  <div class="mode-group">
    <button class="active" data-mode="topk" onclick="switchMode(this)">Top-K</button>
    <button data-mode="threshold" onclick="switchMode(this)">Threshold</button>
    <button data-mode="metadata" onclick="switchMode(this)">Metadata</button>
  </div>

  <!-- Top-K -->
  <form id="mode-topk" onsubmit="searchTopK(event)">
    <label>Query
      <input type="text" id="topkQuery" placeholder="What would you like to find?" required />
    </label>
    <div class="grid">
      <label>K (max results)
        <input type="number" id="topkK" value="5" min="1" max="50" />
      </label>
      <div></div>
    </div>
    <div id="topkTagsWidget"></div>
    <button type="submit" id="topkBtn">Search</button>
  </form>

  <!-- Threshold -->
  <form id="mode-threshold" style="display:none" onsubmit="searchThreshold(event)">
    <label>Query
      <input type="text" id="threshQuery" placeholder="What would you like to find?" required />
    </label>
    <label>Score threshold
      <div class="slider-row">
        <input type="range" id="threshVal" min="0" max="1" step="0.05" value="0.4"
               oninput="document.getElementById('threshReadout').textContent=parseFloat(this.value).toFixed(2)" />
        <span class="slider-readout" id="threshReadout">0.40</span>
      </div>
    </label>
    <div class="grid">
      <label>Limit
        <input type="number" id="threshLimit" value="100" min="1" />
      </label>
      <div></div>
    </div>
    <div id="threshTagsWidget"></div>
    <button type="submit" id="threshBtn">Search</button>
  </form>

  <!-- Metadata -->
  <form id="mode-metadata" style="display:none" onsubmit="searchMetadata(event)">
    <p><small>Browse documents by tag — no query needed, no vector similarity.</small></p>
    <div class="grid">
      <label>Limit
        <input type="number" id="metaLimit" value="25" min="1" />
      </label>
      <div></div>
    </div>
    <div id="metaTagsWidget"></div>
    <button type="submit" id="metaBtn">Browse</button>
  </form>

  <div id="searchResults"></div>
</section>

<!-- ═══════════════════ DOCUMENTS ═══════════════════ -->
<section id="tab-docs" class="tab-panel">
  <hgroup>
    <h2>Documents</h2>
    <p>Index documents into Qdrant — single or batch.</p>
  </hgroup>

  <!-- single doc -->
  <article>
    <h3>Single document</h3>
    <form onsubmit="indexSingle(event)">
      <label>ID <small>(optional)</small>
        <input type="text" id="docId" placeholder="auto-generated if empty" style="font-family:monospace" />
      </label>
      <label>Text
        <textarea id="docText" rows="6" placeholder="Paste your document text here…" required></textarea>
      </label>
      <div id="docTagsWidget"></div>
      <div id="docPropsWidget"></div>
      <button type="submit" id="docBtn">Index Document</button>
    </form>
    <div id="docResult"></div>
  </article>

  <hr />

  <!-- batch -->
  <article>
    <h3>Batch upload</h3>
    <form onsubmit="indexBatch(event)">
      <label>JSON array of documents
        <textarea id="batchJson" rows="10" style="font-family:monospace" placeholder='[
  { "id": "doc-1", "text": "First document…" },
  { "id": "doc-2", "text": "Second document…", "tags": { "category": "science" } }
]'></textarea>
      </label>
      <button type="submit" class="secondary" id="batchBtn">Index Batch</button>
    </form>
    <div id="batchResult"></div>
  </article>
</section>

<!-- ═══════════════════ STATUS ═══════════════════ -->
<section id="tab-status" class="tab-panel">
  <hgroup>
    <h2>Status</h2>
    <p>API configuration and health check.</p>
  </hgroup>

  <article>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem">
      <span id="healthBadge"><span class="health-dot"></span> Checking…</span>
      <button class="outline secondary" style="margin-bottom:0;padding:.3rem .8rem;font-size:.85rem"
              onclick="loadStatus()">Refresh</button>
    </div>
    <dl class="status-grid" id="statusGrid">
      <dt>Loading…</dt><dd></dd>
    </dl>
  </article>
</section>

</main>

<footer>Qdrant.Demo Workshop · <a href="https://github.com/PeterMilovcik/Qdrant.Demo" target="_blank">GitHub</a> · <a href="/swagger" target="_blank">Swagger UI</a></footer>

<!-- ═══════════════════ JS ═══════════════════ -->
<script>
const BASE = '';  // same origin

// ── tabs ──
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', e => {
    e.preventDefault();
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    if (btn.dataset.tab === 'status') loadStatus();
  });
});

// ── tag widget factory ──
function createTagWidget(containerId, label = 'Tags') {
  const el = document.getElementById(containerId);
  const tags = {};
  el.innerHTML = `
    <label>${label}</label>
    <div class="chip-row">
      <input type="text" placeholder="key" style="max-width:120px" />
      <input type="text" placeholder="value" style="max-width:160px" />
      <button type="button" class="outline secondary" style="padding:.4rem .7rem">Add</button>
    </div>
    <div class="chip-list"></div>`;
  const [kIn, vIn] = el.querySelectorAll('input');
  const addBtn = el.querySelector('button');
  const list = el.querySelector('.chip-list');
  const refresh = () => {
    list.innerHTML = '';
    for (const [k, v] of Object.entries(tags)) {
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.innerHTML = `<code>${esc(k)}: ${esc(v)}</code> <button type="button" data-key="${esc(k)}">&times;</button>`;
      chip.querySelector('button').onclick = () => { delete tags[k]; refresh(); };
      list.appendChild(chip);
    }
  };
  const add = () => { const k=kIn.value.trim(), v=vIn.value.trim(); if(k&&v){tags[k]=v;kIn.value='';vIn.value='';refresh();} };
  addBtn.onclick = add;
  [kIn, vIn].forEach(i => i.addEventListener('keydown', e => { if(e.key==='Enter'){e.preventDefault();add();} }));
  return () => Object.keys(tags).length ? {...tags} : null;
}

function esc(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

// ── theme selector ──
function setTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('theme', theme);
}
(function() {
  const saved = localStorage.getItem('theme') || 'auto';
  document.documentElement.setAttribute('data-theme', saved);
  document.getElementById('themeSelect').value = saved;
})();

// init tag widgets
const getTopkTags   = createTagWidget('topkTagsWidget');
const getThreshTags = createTagWidget('threshTagsWidget');
const getMetaTags   = createTagWidget('metaTagsWidget');
const getChatTags   = createTagWidget('chatTagsWidget');
const getDocTags    = createTagWidget('docTagsWidget');
const getDocProps   = createTagWidget('docPropsWidget', 'Properties');

// ── helpers ──
async function api(method, path, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body !== undefined) opts.body = JSON.stringify(body);
  const t0 = performance.now();
  const res = await fetch(BASE + path, opts);
  const ms = Math.round(performance.now() - t0);
  const data = res.headers.get('content-type')?.includes('json') ? await res.json() : await res.text();
  if (!res.ok) throw { status: res.status, data };
  return { data, ms };
}

function setBusy(btnId, busy) {
  const btn = document.getElementById(btnId);
  if (btn) btn.ariaBusy = busy ? 'true' : null;
}

function scoreColor(s) { return s >= 0.7 ? 'var(--score-high)' : s >= 0.4 ? 'var(--score-mid)' : 'var(--score-low)'; }

function truncate(s, n=150) { return s && s.length > n ? s.slice(0, n) + '…' : s || ''; }

function renderPayload(payload) {
  return Object.entries(payload||{}).map(([k,v]) => `<b>${esc(k)}</b>: ${esc(String(v??''))}`).join('<br/>');
}

function renderHits(hits, ms, container) {
  const el = document.getElementById(container);
  if (!hits.length) { el.innerHTML = '<p class="empty-state">No results found. Try a different query or adjust your filters.</p>'; return; }
  let html = `<p class="results-info">${hits.length} result${hits.length!==1?'s':''} in ${ms}ms</p>`;
  hits.forEach((h, i) => {
    const text = h.payload?.text || h.payload?.Text || '';
    const srcDoc = h.payload?.source_doc_id;
    const chunkIdx = h.payload?.chunk_index;
    const totalChunks = h.payload?.total_chunks;
    const isMetadata = h.score === 0;
    html += `<div class="result-card">
      <div class="result-header">
        <span class="rank">#${i+1}</span>
        ${isMetadata ? '<span class="score-num" style="opacity:.4">N/A</span>'
          : `<div class="score-bar-wrap">
              <progress value="${h.score}" max="1" style="--pico-progress-color:${scoreColor(h.score)}"></progress>
              <span class="score-num">${h.score.toFixed(2)}</span>
            </div>`}
        <span class="doc-id" title="${esc(h.id||'')}">${esc(h.id||'')}</span>
        ${srcDoc ? `<span class="chunk-badge">Chunk ${Number(chunkIdx)+1}/${totalChunks}</span>` : ''}
      </div>
      <p class="snippet">${esc(truncate(text))}</p>
      <details class="result-meta"><summary>Show payload</summary><p>${renderPayload(h.payload)}</p></details>
    </div>`;
  });
  el.innerHTML = html;
}

// ── search mode toggle ──
function switchMode(btn) {
  document.querySelectorAll('.mode-group button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  ['topk','threshold','metadata'].forEach(m => {
    document.getElementById('mode-'+m).style.display = m===btn.dataset.mode ? '' : 'none';
  });
  document.getElementById('searchResults').innerHTML = '';
}

// ── search: top-k ──
async function searchTopK(e) {
  e.preventDefault(); setBusy('topkBtn', true);
  try {
    const body = { queryText: document.getElementById('topkQuery').value, k: +document.getElementById('topkK').value };
    const tags = getTopkTags(); if (tags) body.tags = tags;
    const { data, ms } = await api('POST', '/search/topk', body);
    renderHits(data, ms, 'searchResults');
  } catch(err) { document.getElementById('searchResults').innerHTML = `<div class="result-card error">${esc(JSON.stringify(err.data||err))}</div>`; }
  setBusy('topkBtn', false);
}

// ── search: threshold ──
async function searchThreshold(e) {
  e.preventDefault(); setBusy('threshBtn', true);
  try {
    const body = { queryText: document.getElementById('threshQuery').value,
                   scoreThreshold: +document.getElementById('threshVal').value,
                   limit: +document.getElementById('threshLimit').value };
    const tags = getThreshTags(); if (tags) body.tags = tags;
    const { data, ms } = await api('POST', '/search/threshold', body);
    renderHits(data, ms, 'searchResults');
  } catch(err) { document.getElementById('searchResults').innerHTML = `<div class="result-card error">${esc(JSON.stringify(err.data||err))}</div>`; }
  setBusy('threshBtn', false);
}

// ── search: metadata ──
async function searchMetadata(e) {
  e.preventDefault(); setBusy('metaBtn', true);
  try {
    const body = { limit: +document.getElementById('metaLimit').value };
    const tags = getMetaTags(); if (tags) body.tags = tags;
    const { data, ms } = await api('POST', '/search/metadata', body);
    renderHits(data, ms, 'searchResults');
  } catch(err) { document.getElementById('searchResults').innerHTML = `<div class="result-card error">${esc(JSON.stringify(err.data||err))}</div>`; }
  setBusy('metaBtn', false);
}

// ── index: single ──
async function indexSingle(e) {
  e.preventDefault(); setBusy('docBtn', true);
  try {
    const body = { text: document.getElementById('docText').value };
    const id = document.getElementById('docId').value.trim();
    if (id) body.id = id;
    const tags = getDocTags(); if (tags) body.tags = tags;
    const props = getDocProps(); if (props) body.properties = props;
    const { data } = await api('POST', '/documents', body);
    const chunks = data.chunkPointIds || [];
    let html = `<div class="result-card success" style="margin-top:.75rem">
      <p><b>Point ID:</b> <code>${esc(data.pointId)}</code></p>
      <p><span class="chunk-badge">${data.totalChunks} chunk${data.totalChunks!==1?'s':''}</span></p>`;
    if (chunks.length > 1) {
      html += `<details><summary>Chunk IDs</summary><ul style="font-family:monospace;font-size:.8rem">`;
      chunks.forEach(c => html += `<li>${esc(c)}</li>`);
      html += '</ul></details>';
    }
    html += '</div>';
    document.getElementById('docResult').innerHTML = html;
  } catch(err) { document.getElementById('docResult').innerHTML = `<div class="result-card error" style="margin-top:.75rem">${esc(JSON.stringify(err.data||err))}</div>`; }
  setBusy('docBtn', false);
}

// ── index: batch ──
async function indexBatch(e) {
  e.preventDefault(); setBusy('batchBtn', true);
  try {
    const docs = JSON.parse(document.getElementById('batchJson').value);
    const { data } = await api('POST', '/documents/batch', docs);
    let html = `<div class="batch-stats">
      <span>Total: <span class="val">${data.total}</span></span>
      <span>Succeeded: <span class="val ok">${data.succeeded}</span></span>`;
    if (data.failed > 0) html += `<span>Failed: <span class="val err">${data.failed}</span></span>`;
    html += '</div>';
    if (data.errors && data.errors.length) {
      html += '<details><summary>Errors</summary><ul>';
      data.errors.forEach(e => html += `<li>${esc(e)}</li>`);
      html += '</ul></details>';
    }
    document.getElementById('batchResult').innerHTML = html;
  } catch(err) { document.getElementById('batchResult').innerHTML = `<div class="result-card error">${esc(typeof err.data==='object'? JSON.stringify(err.data):String(err))}</div>`; }
  setBusy('batchBtn', false);
}

// ── chat ──
const chatArea = document.getElementById('chatArea');

function clearChat() { chatArea.innerHTML = ''; }

function appendMsg(role, html) {
  const div = document.createElement('div');
  div.className = 'msg ' + role;
  div.innerHTML = `<div class="bubble">${html}</div>`;
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;
  return div;
}

async function sendChat() {
  const q = document.getElementById('chatQ').value.trim();
  if (!q) return;
  document.getElementById('chatQ').value = '';
  appendMsg('user', `<p>${esc(q)}</p>`);

  const thinking = appendMsg('assistant', '<p class="thinking">Thinking…</p>');
  setBusy('chatSend', true);

  try {
    const body = { question: q, k: +document.getElementById('chatK').value };
    const thresh = document.getElementById('chatThresh').value;
    if (thresh) body.scoreThreshold = +thresh;
    const tags = getChatTags(); if (tags) body.tags = tags;
    const prompt = document.getElementById('chatPrompt').value.trim();
    if (prompt) body.systemPrompt = prompt;

    const { data } = await api('POST', '/chat', body);

    // render answer
    let html = `<p>${esc(data.answer).replace(/\n/g, '<br/>')}</p>`;

    // render sources
    if (data.sources && data.sources.length) {
      html += `<details class="sources-toggle"><summary>${data.sources.length} source${data.sources.length!==1?'s':''} used</summary>`;
      data.sources.forEach(s => {
        html += `<div class="result-card" style="margin:.35rem 0;padding:.5rem .7rem">
          <div class="result-header">
            <div class="score-bar-wrap">
              <progress value="${s.score}" max="1" style="--pico-progress-color:${scoreColor(s.score)}"></progress>
              <span class="score-num">${s.score.toFixed(2)}</span>
            </div>
            <span class="doc-id" title="${esc(s.id)}">${esc(s.id)}</span>
          </div>
          <p class="snippet">${esc(truncate(s.textSnippet, 200))}</p>
        </div>`;
      });
      html += '</details>';
    }

    thinking.querySelector('.bubble').innerHTML = html;
  } catch(err) {
    thinking.querySelector('.bubble').innerHTML = `<p style="color:var(--score-low)">${esc(JSON.stringify(err.data||err))}</p>`;
  }
  setBusy('chatSend', false);
  chatArea.scrollTop = chatArea.scrollHeight;
}

// submit chat on Enter (Shift+Enter for newline)
document.getElementById('chatQ').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
});

// ── status ──
async function loadStatus() {
  try {
    const [info, health] = await Promise.all([
      api('GET', '/api/info').then(r => r.data),
      api('GET', '/health').then(r => r.data).catch(() => null)
    ]);
    const badge = document.getElementById('healthBadge');
    if (health === 'healthy') {
      badge.innerHTML = '<span class="health-dot health-ok"></span> Healthy';
    } else {
      badge.innerHTML = '<span class="health-dot health-err"></span> Unreachable';
    }
    const grid = document.getElementById('statusGrid');
    grid.innerHTML = `
      <dt>Service</dt><dd>${esc(info.service)}</dd>
      <dt>Qdrant Host</dt><dd>${esc(info.qdrant?.host)}</dd>
      <dt>HTTP Port</dt><dd>${info.qdrant?.http}</dd>
      <dt>gRPC Port</dt><dd>${info.qdrant?.grpc}</dd>
      <dt>Collection</dt><dd>${esc(info.qdrant?.collection)}</dd>
      <dt>Embedding Dim</dt><dd>${info.qdrant?.embeddingDim}</dd>
      <dt>Embedding Model</dt><dd>${esc(info.embeddingModel)}</dd>
      <dt>Chat Model</dt><dd>${esc(info.chatModel)}</dd>
      <dt>Max Chunk Size</dt><dd>${info.chunking?.maxChunkSize}</dd>
      <dt>Overlap</dt><dd>${info.chunking?.overlap}</dd>`;
  } catch {
    document.getElementById('healthBadge').innerHTML = '<span class="health-dot health-err"></span> Unreachable';
    document.getElementById('statusGrid').innerHTML = '<dt>Error</dt><dd>Could not connect to the API</dd>';
  }
}

// auto-refresh health every 15s
setInterval(async () => {
  try {
    const { data } = await api('GET', '/health');
    document.getElementById('healthBadge').innerHTML = data === 'healthy'
      ? '<span class="health-dot health-ok"></span> Healthy'
      : '<span class="health-dot health-err"></span> Unreachable';
  } catch { document.getElementById('healthBadge').innerHTML = '<span class="health-dot health-err"></span> Unreachable'; }
}, 15000);
</script>

</body>
</html>
